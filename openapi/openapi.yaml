openapi: 3.1.0
info:
  title: Waste-Of-Money API
  version: 0.1.0
  description: 無駄遣い防止アプリのAPI。金額は税込で保存・返却（MVP税率10%）。
servers:
  - url: https://api.example.com
    description: production
  - url: http://localhost:8787
    description: local dev (wrangler)
tags:
  - name: alt
  - name: intent
  - name: decision
  - name: summary
  - name: sync
components:
  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      schema: { type: string }
    RequestId:
      name: X-Request-Id
      in: header
      required: false
      schema: { type: string }
  schemas:
    Tone:
      type: string
      enum: [gentle, humor, spartan]
    Alternative:
      type: object
      required: [id, text, source]
      properties:
        id: { type: string }
        text: { type: string }
        tag: { type: string }
        source: { type: string, enum: [rule, ai] }
        score: { type: number, minimum: 0, maximum: 1 }
    AltRequest:
      type: object
      required: [amount]
      properties:
        amount: { type: integer, minimum: 1, maximum: 50000 }
        inputIsPretax: { type: boolean, default: false }
        taxRate: { type: number, default: 0.10 }
        goal: { type: string }
        hobbies: { type: array, items: { type: string }, maxItems: 5 }
        tone: { $ref: '#/components/schemas/Tone' }
        locale: { type: string, enum: [ja-JP], default: ja-JP }
        category: { type: string, enum: [snack, drink, meal, hobby, other] }
    AltResponse:
      type: object
      required: [intentId, alternatives]
      properties:
        intentId: { type: string }
        alternatives:
          type: array
          items: { $ref: '#/components/schemas/Alternative' }
    IntentRequest:
      type: object
      required: [amount]
      properties:
        amount: { type: integer, minimum: 1, maximum: 50000 }
        inputIsPretax: { type: boolean, default: false }
        taxRate: { type: number, default: 0.10 }
        category: { type: string, enum: [snack, drink, meal, hobby, other] }
        hungerLevel: { type: string, enum: [none, low, medium, high] }
    DecisionRequest:
      type: object
      required: [intentId, outcome]
      properties:
        intentId: { type: string }
        outcome: { type: string, enum: [avoided, purchased] }
        savedAmount: { type: number }
        reasonTag: { type: string }
        tone: { $ref: '#/components/schemas/Tone' }
    SummaryResponse:
      type: object
      required: [monthSavedTotalInclTax, streak, countAvoided]
      properties:
        monthSavedTotalInclTax: { type: number }
        streak: { type: integer }
        countAvoided: { type: integer }
    ErrorResponse:
      type: object
      required: [error, requestId]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code: { type: string }
            message: { type: string }
            details: { type: object, additionalProperties: true }
        requestId: { type: string }
paths:
  /api/alt:
    post:
      tags: [alt]
      parameters: [{ $ref: '#/components/parameters/IdempotencyKey' }, { $ref: '#/components/parameters/RequestId' }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AltRequest' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/AltResponse' } } } }
        '400': { description: Bad Request, content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } } }
  /api/intent:
    post:
      tags: [intent]
      parameters: [{ $ref: '#/components/parameters/IdempotencyKey' }, { $ref: '#/components/parameters/RequestId' }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/IntentRequest' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { intentId: { type: string } }, required: [intentId] } } } }
        '400': { description: Bad Request, content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } } }
  /api/decision:
    post:
      tags: [decision]
      parameters: [{ $ref: '#/components/parameters/IdempotencyKey' }, { $ref: '#/components/parameters/RequestId' }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/DecisionRequest' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { ok: { type: boolean } }, required: [ok] } } } }
        '400': { description: Bad Request, content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } } }
  /api/summary:
    get:
      tags: [summary]
      parameters:
        - in: query
          name: month
          required: false
          description: >
            対象月（例: 2025-10）。`month` と `from/to` の同時指定は不可。
          schema:
            type: string
            pattern: '^\\d{4}-\\d{2}$'
        - in: query
          name: from
          required: false
          description: >
            期間開始（ISO8601日時、Asia/Tokyo 基準）。指定する場合は `to` も必須。
          schema:
            type: string
            format: date-time
        - in: query
          name: to
          required: false
          description: >
            期間終了（ISO8601日時、Asia/Tokyo 基準）。指定する場合は `from` も必須。
          schema:
            type: string
            format: date-time
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/SummaryResponse' } } } }
  /api/sync:
    post:
      tags: [sync]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [events, clientId, batchId]
              properties:
                clientId: { type: string }
                batchId: { type: string }
                events:
                  type: array
                  maxItems: 50
                  items:
                    type: object
                    required: [type, payload, idempotencyKey, client_ts]
                    properties:
                      type: { type: string, enum: [intent, decision] }
                      idempotencyKey: { type: string }
                      client_ts: { type: string, format: date-time }
                      payload: { type: object }
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { stored: { type: integer }, duplicates: { type: integer } }, required: [stored, duplicates] } } } }
